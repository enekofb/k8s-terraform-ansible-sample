---
- name: Apt update
  raw: "apt-get update"
  retries: 10
  delay: 20

- name: Install Python
  raw: "apt-get install -y python"
  retries: 10
  delay: 20

- name: setup google cloud reops
  command: bash -c "curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -"

- name: setup repos
  command: bash -c "echo deb http://apt.kubernetes.io/ kubernetes-xenial main >> /etc/apt/sources.list.d/kubernetes.list"

- name: Apt update
  raw: "apt-get update"
  retries: 10
  delay: 20

- name: Install packages
  apt:
    name: "{{item}}"
    state: present
  with_items:
    - docker.io

- name: Download Kubernetes binaries
  get_url:
    url: "{{ kubernetes_download_path}}/{{ item }}"
    dest: "/usr/bin"
    group: root
    owner: root
    mode: 0755
    # TODO Add hash check
  with_items:
    - kubectl
    - kubeadm
    - kubelet
  become: true

- name: kubeadm reset
  command: "kubeadm reset"

- name: generate kubeadm token
  command: kubeadm token generate
  register: kubetoken
  run_once: true
